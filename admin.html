<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Portal | EverGreen Empire</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --navy: #071b3b;
      --gold: #cda349;
      --light-gold: #f4e4a9;
      --white: #ffffff;
      --light: #f5f7fa;
      --danger: #dc3545;
      --success: #28a745;
      --warning: #ffc107;
      --info: #17a2b8;
      --shadow: rgba(0,0,0,0.1);
      --border-radius: 12px;
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: var(--navy);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Header */
    .admin-header {
      background: var(--navy);
      color: var(--white);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .admin-header h1 {
      font-size: 20px;
      color: var(--gold);
      font-weight: 700;
    }

    .admin-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .admin-email {
      background: rgba(255,255,255,0.1);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
    }

    .logout-btn {
      background: var(--gold);
      color: var(--navy);
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      font-size: 12px;
    }

    .logout-btn:hover {
      background: #e6b800;
      transform: translateY(-1px);
    }

    /* Mobile Menu Button */
    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: var(--white);
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
    }

    /* Main Layout */
    .admin-container {
      display: grid;
      grid-template-columns: 250px 1fr;
      min-height: calc(100vh - 70px);
    }

    /* Sidebar */
    .admin-sidebar {
      background: var(--white);
      border-right: 1px solid #e0e0e0;
      padding: 20px 0;
      transition: transform 0.3s ease;
      box-shadow: 2px 0 5px rgba(0,0,0,0.05);
    }

    .sidebar-menu {
      list-style: none;
    }

    .sidebar-menu li {
      margin-bottom: 5px;
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      color: var(--navy);
      text-decoration: none;
      transition: var(--transition);
      border-left: 3px solid transparent;
      font-size: 14px;
    }

    .sidebar-menu a:hover,
    .sidebar-menu a.active {
      background: var(--light);
      border-left-color: var(--gold);
      color: var(--gold);
    }

    .menu-icon {
      font-size: 16px;
      width: 20px;
      text-align: center;
    }

    /* Main Content */
    .admin-main {
      padding: 20px;
      background: var(--white);
      margin: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 10px var(--shadow);
      overflow-x: auto;
    }

    .section-title {
      font-size: 20px;
      margin-bottom: 20px;
      color: var(--navy);
      border-bottom: 2px solid var(--gold);
      padding-bottom: 10px;
      font-weight: 700;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--navy), #0a2458);
      color: var(--white);
      padding: 20px;
      border-radius: var(--border-radius);
      text-align: center;
      transition: var(--transition);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.2);
    }

    .stat-card h3 {
      font-size: 14px;
      margin-bottom: 10px;
      color: var(--gold);
    }

    .stat-card .number {
      font-size: 24px;
      font-weight: 700;
    }

    /* Withdrawal Alert */
    .withdrawal-alert {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: var(--border-radius);
      padding: 15px;
      margin-bottom: 20px;
      display: none;
      animation: slideDown 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .withdrawal-alert.show {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    @keyframes slideDown {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Urgent Withdrawal Styles */
    .urgent-withdrawal {
      background: linear-gradient(135deg, #dc3545, #c82333) !important;
      border: 2px solid #ff6b7a;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    .new-request-badge {
      background: #dc3545;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      margin-left: 5px;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      margin-bottom: 25px;
      border: 1px solid #e0e0e0;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--white);
      min-width: 800px;
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
      font-size: 12px;
    }

    th {
      background: var(--light);
      font-weight: 600;
      color: var(--navy);
      position: sticky;
      top: 0;
    }

    tr:hover {
      background: #f8f9fa;
    }

    /* Status Badges */
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      display: inline-block;
      text-align: center;
      min-width: 80px;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-paid {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }

    .status-processing {
      background: #cce7ff;
      color: #004085;
    }

    /* Buttons */
    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      transition: var(--transition);
      margin: 2px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 10px;
    }

    .btn-primary {
      background: var(--navy);
      color: var(--white);
    }

    .btn-primary:hover {
      background: #0a2458;
      transform: translateY(-1px);
    }

    .btn-success {
      background: var(--success);
      color: var(--white);
    }

    .btn-success:hover {
      background: #218838;
      transform: translateY(-1px);
    }

    .btn-danger {
      background: var(--danger);
      color: var(--white);
    }

    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-1px);
    }

    .btn-warning {
      background: var(--warning);
      color: var(--navy);
    }

    .btn-warning:hover {
      background: #e0a800;
      transform: translateY(-1px);
    }

    .btn-info {
      background: var(--info);
      color: var(--white);
    }

    .btn-info:hover {
      background: #138496;
      transform: translateY(-1px);
    }

    /* Action Buttons Container */
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-content {
      background: var(--white);
      padding: 25px;
      border-radius: var(--border-radius);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      color: var(--navy);
      font-weight: 700;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      transition: var(--transition);
    }

    .close-modal:hover {
      color: var(--danger);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--navy);
      font-size: 12px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 12px;
      transition: var(--transition);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 2px rgba(205, 163, 73, 0.2);
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: var(--border-radius);
      color: white;
      font-weight: 600;
      z-index: 10000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: var(--success);
    }

    .notification.error {
      background: var(--danger);
    }

    .notification.info {
      background: var(--navy);
    }

    .notification.warning {
      background: var(--warning);
      color: var(--navy);
    }

    /* Access Denied Screen */
    .access-denied {
      display: none;
      text-align: center;
      padding: 50px 20px;
      background: var(--white);
      max-width: 500px;
      margin: 50px auto;
      border-radius: var(--border-radius);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .access-denied h2 {
      color: var(--danger);
      margin-bottom: 15px;
      font-size: 20px;
    }

    .access-denied p {
      color: var(--navy);
      margin-bottom: 20px;
      font-size: 14px;
    }

    /* Balance Warning */
    .balance-warning {
      color: #dc3545;
      font-weight: bold;
      font-size: 10px;
      background: #f8d7da;
      padding: 2px 4px;
      border-radius: 3px;
      margin-top: 2px;
    }

    .balance-ok {
      color: var(--success);
      font-weight: bold;
      font-size: 10px;
      background: #d4edda;
      padding: 2px 4px;
      border-radius: 3px;
      margin-top: 2px;
    }

    /* PayPal Info */
    .paypal-info {
      background: #f0f8ff;
      border: 1px solid #0070ba;
      border-radius: var(--border-radius);
      padding: 15px;
      margin: 10px 0;
    }

    .paypal-email {
      color: #0070ba;
      font-weight: 600;
      font-size: 12px;
    }

    .no-paypal {
      color: #666;
      font-style: italic;
      font-size: 11px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 20px;
      overflow-x: auto;
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: var(--transition);
      white-space: nowrap;
      font-size: 12px;
    }

    .tab.active {
      border-bottom-color: var(--gold);
      color: var(--gold);
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .admin-container {
        grid-template-columns: 1fr;
      }

      .admin-sidebar {
        position: fixed;
        top: 70px;
        left: 0;
        width: 250px;
        height: calc(100vh - 70px);
        transform: translateX(-100%);
        z-index: 99;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      }

      .admin-sidebar.mobile-open {
        transform: translateX(0);
      }

      .mobile-menu-btn {
        display: block;
      }

      .admin-main {
        margin: 10px;
        padding: 15px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .stat-card {
        padding: 15px;
      }

      .stat-card .number {
        font-size: 20px;
      }

      .modal-content {
        margin: 10px;
        padding: 20px;
      }

      .modal-actions {
        justify-content: stretch;
      }

      .modal-actions button {
        flex: 1;
      }

      .withdrawal-alert.show {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 480px) {
      .admin-header {
        padding: 10px 15px;
      }

      .admin-header h1 {
        font-size: 16px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .admin-info {
        flex-direction: column;
        align-items: flex-end;
        gap: 5px;
      }

      .admin-email {
        font-size: 10px;
        padding: 4px 8px;
      }

      .logout-btn {
        padding: 4px 8px;
        font-size: 10px;
      }

      .tabs {
        flex-wrap: wrap;
      }

      .tab {
        flex: 1;
        min-width: 120px;
        text-align: center;
      }
    }

    /* Loading Spinner */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .empty-state i {
      font-size: 40px;
      margin-bottom: 10px;
      opacity: 0.5;
    }

    /* Withdrawal Details */
    .withdrawal-details {
      background: var(--light);
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 15px;
      border-left: 4px solid var(--gold);
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e0e0e0;
    }

    .detail-row:last-child {
      margin-bottom: 0;
      border-bottom: none;
    }

    .detail-label {
      font-weight: 600;
      color: var(--navy);
    }

    .detail-value {
      color: #666;
    }

    /* Payment Badge */
    .payment-badge {
      background: var(--success);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 9px;
      margin-left: 5px;
    }

    /* Quick Stats */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .quick-stat {
      background: var(--white);
      padding: 15px;
      border-radius: var(--border-radius);
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      border: 1px solid #e0e0e0;
    }

    .quick-stat .value {
      font-size: 18px;
      font-weight: 700;
      color: var(--navy);
    }

    .quick-stat .label {
      font-size: 11px;
      color: #666;
      margin-top: 5px;
    }

    /* Search and Filter */
    .search-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .search-box {
      flex: 1;
      min-width: 200px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 10px 35px 10px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 12px;
    }

    .search-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
    }
  </style>
</head>
<body>
  <!-- Notification -->
  <div id="notification" class="notification"></div>

  <!-- Withdrawal Alert -->
  <div id="withdrawalAlert" class="withdrawal-alert">
    <div>
      <strong>üö® New Withdrawal Request!</strong> 
      <span id="alertMessage"></span>
    </div>
    <button class="btn btn-primary btn-sm" onclick="showTab('withdrawals')">
      View Requests
    </button>
  </div>

  <!-- Access Denied Screen -->
  <div id="accessDenied" class="access-denied">
    <h2>üö´ Access Denied</h2>
    <p>This portal is restricted to administrators only.</p>
    <p>If you believe this is an error, please contact system administration.</p>
    <button class="logout-btn" onclick="goHome()">Return to Homepage</button>
  </div>

  <!-- Admin Content (Hidden by default) -->
  <div id="adminContent" style="display: none;">
    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Edit User Stats</h3>
          <button class="close-modal" onclick="closeEditModal()">√ó</button>
        </div>
        <form id="editUserForm">
          <input type="hidden" id="editUserId">
          
          <div class="form-group">
            <label>Total Views</label>
            <input type="number" id="editTotalViews" required>
          </div>
          
          <div class="form-group">
            <label>Monetized Views</label>
            <input type="number" id="editMonetizedViews" required>
          </div>
          
          <div class="form-group">
            <label>Revenue (‚Ç¨)</label>
            <input type="number" id="editRevenue" step="0.01" required>
          </div>

          <div class="form-group">
            <label>Available Balance (‚Ç¨)</label>
            <input type="number" id="editAvailableBalance" step="0.01" required>
          </div>
          
          <div class="form-group">
            <label>Contract Status</label>
            <select id="editContractStatus" required>
              <option value="Active">Active</option>
              <option value="Pending">Pending</option>
              <option value="Suspended">Suspended</option>
            </select>
          </div>
          
          <div class="modal-actions">
            <button type="button" class="btn btn-primary" onclick="closeEditModal()">Cancel</button>
            <button type="submit" class="btn btn-success">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Delete User Modal -->
    <div id="deleteUserModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Delete User</h3>
          <button class="close-modal" onclick="closeDeleteModal()">√ó</button>
        </div>
        <div class="form-group">
          <p><strong>Warning:</strong> This action cannot be undone. All user data including stats and withdrawal history will be permanently deleted.</p>
          <p>User: <strong id="deleteUserName">N/A</strong></p>
          <p>Email: <strong id="deleteUserEmail">N/A</strong></p>
        </div>
        <div class="form-group">
          <label for="confirmDelete">Type "DELETE" to confirm:</label>
          <input type="text" id="confirmDelete" placeholder="Type DELETE here" style="border: 2px solid var(--danger);">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-primary" onclick="closeDeleteModal()">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteUser()" disabled>
            Delete User Permanently
          </button>
        </div>
      </div>
    </div>

    <!-- Process Withdrawal Modal -->
    <div id="processWithdrawalModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Process Withdrawal Request</h3>
          <button class="close-modal" onclick="closeProcessModal()">√ó</button>
        </div>
        
        <div class="withdrawal-details" id="withdrawalDetailsContent">
          <!-- Withdrawal details will be populated here -->
        </div>
        
        <form id="processWithdrawalForm">
          <input type="hidden" id="processWithdrawalId">
          
          <div class="form-group">
            <label>Update Status</label>
            <select id="withdrawalAction" required onchange="toggleNotesField()">
              <option value="pending">‚è≥ Leave as Pending</option>
              <option value="processing">üîÑ Mark as Processing</option>
              <option value="paid">‚úÖ Mark as Paid</option>
              <option value="rejected">‚ùå Reject Request</option>
            </select>
          </div>
          
          <div class="form-group" id="notesField" style="display: none;">
            <label>Admin Notes</label>
            <textarea id="adminNotes" rows="3" placeholder="Add notes about this withdrawal decision..."></textarea>
            <small style="color: #666;">Notes are required for rejected withdrawals and recommended for other status changes.</small>
          </div>

          <div class="form-group" id="balanceWarning" style="display: none;">
            <div class="balance-warning">
              ‚ö†Ô∏è This will permanently deduct ‚Ç¨<span id="deductionAmount">0</span> from the creator's balance.
            </div>
          </div>
          
          <div class="modal-actions">
            <button type="button" class="btn btn-primary" onclick="closeProcessModal()">Cancel</button>
            <button type="submit" class="btn btn-success" id="processWithdrawalBtn">Update Status</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Header -->
    <header class="admin-header">
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
      <h1>EverGreen Empire - Admin Portal</h1>
      <div class="admin-info">
        <span class="admin-email" id="adminEmail">admin@evergreenempireltd.com</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </header>

    <!-- Main Container -->
    <div class="admin-container">
      <!-- Sidebar -->
      <nav class="admin-sidebar" id="sidebar">
        <ul class="sidebar-menu">
          <li><a href="#" class="active" onclick="showTab('dashboard')"><span class="menu-icon">üìä</span> Dashboard</a></li>
          <li><a href="#" onclick="showTab('users')"><span class="menu-icon">üë•</span> Manage Users</a></li>
          <li><a href="#" onclick="showTab('withdrawals')"><span class="menu-icon">üí∞</span> Withdrawal Requests</a></li>
          <li><a href="#" onclick="showTab('payments')"><span class="menu-icon">üí≥</span> Payment Methods</a></li>
        </ul>
      </nav>

      <!-- Main Content -->
      <main class="admin-main">
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
          <h2 class="section-title">Admin Dashboard</h2>
          
          <!-- Quick Stats -->
          <div class="quick-stats">
            <div class="quick-stat">
              <div class="value" id="totalUsersQuick">0</div>
              <div class="label">Total Users</div>
            </div>
            <div class="quick-stat">
              <div class="value" id="pendingWithdrawalsQuick">0</div>
              <div class="label">Pending Withdrawals</div>
            </div>
            <div class="quick-stat">
              <div class="value" id="totalRevenueQuick">‚Ç¨0</div>
              <div class="label">Total Revenue</div>
            </div>
            <div class="quick-stat">
              <div class="value" id="activeContractsQuick">0</div>
              <div class="label">Active Contracts</div>
            </div>
          </div>
          
          <!-- Stats -->
          <div class="stats-grid">
            <div class="stat-card">
              <h3>Total Users</h3>
              <div class="number" id="totalUsers">0</div>
            </div>
            <div class="stat-card">
              <h3>Pending Withdrawals</h3>
              <div class="number" id="pendingWithdrawals">0</div>
            </div>
            <div class="stat-card">
              <h3>Processing Withdrawals</h3>
              <div class="number" id="processingWithdrawals">0</div>
            </div>
            <div class="stat-card">
              <h3>Total Revenue</h3>
              <div class="number" id="totalRevenue">‚Ç¨0</div>
            </div>
            <div class="stat-card">
              <h3>Active Contracts</h3>
              <div class="number" id="activeContracts">0</div>
            </div>
            <div class="stat-card">
              <h3>PayPal Users</h3>
              <div class="number" id="paypalUsers">0</div>
            </div>
          </div>

          <!-- Recent Activity -->
          <h3 class="section-title">Recent Withdrawal Requests</h3>
          <div class="table-container">
            <table id="recentWithdrawalsTable">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Amount</th>
                  <th>PayPal Email</th>
                  <th>Requested</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="recentWithdrawalsBody">
                <!-- Recent withdrawals will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="tab-content">
          <h2 class="section-title">Manage Users</h2>
          
          <!-- Search and Filter -->
          <div class="search-filter">
            <div class="search-box">
              <input type="text" id="userSearch" placeholder="Search users..." onkeyup="filterUsers()">
              <span class="search-icon">üîç</span>
            </div>
          </div>
          
          <div class="table-container">
            <table id="usersTable">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>PayPal</th>
                  <th>YouTube</th>
                  <th>Total Views</th>
                  <th>Available Balance</th>
                  <th>Total Revenue</th>
                  <th>Contract Status</th>
                  <th>Last Updated</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <!-- Users will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Withdrawals Tab -->
        <div id="withdrawals-tab" class="tab-content">
          <h2 class="section-title">Withdrawal Requests</h2>
          
          <!-- Quick Stats -->
          <div class="quick-stats">
            <div class="quick-stat">
              <div class="value" id="totalWithdrawals">0</div>
              <div class="label">Total Requests</div>
            </div>
            <div class="quick-stat">
              <div class="value" id="pendingCount">0</div>
              <div class="label">Pending</div>
            </div>
            <div class="quick-stat">
              <div class="value" id="processingCount">0</div>
              <div class="label">Processing</div>
            </div>
            <div class="quick-stat">
              <div class="value" id="paidCount">0</div>
              <div class="label">Paid</div>
            </div>
          </div>
          
          <div class="tabs">
            <div class="tab active" onclick="filterWithdrawals('all')">All Requests</div>
            <div class="tab" onclick="filterWithdrawals('pending')">‚è≥ Pending</div>
            <div class="tab" onclick="filterWithdrawals('processing')">üîÑ Processing</div>
            <div class="tab" onclick="filterWithdrawals('paid')">‚úÖ Paid</div>
            <div class="tab" onclick="filterWithdrawals('rejected')">‚ùå Rejected</div>
          </div>
          <div class="table-container">
            <table id="withdrawalsTable">
              <thead>
                <tr>
                  <th>User</th>
                  <th>PayPal Email</th>
                  <th>Amount</th>
                  <th>Requested</th>
                  <th>Status</th>
                  <th>Balance Info</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="withdrawalsTableBody">
                <!-- Withdrawals will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Payment Methods Tab -->
        <div id="payments-tab" class="tab-content">
          <h2 class="section-title">Payment Methods</h2>
          <div class="table-container">
            <table id="paymentsTable">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Email</th>
                  <th>PayPal Email</th>
                  <th>Payment Setup</th>
                  <th>Available Balance</th>
                  <th>Last Withdrawal</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="paymentsTableBody">
                <!-- Payment methods will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
  // Supabase Configuration - UPDATED TO YOUR API
  const SUPABASE_URL = 'https://saerrnuzddfxfthllvpr.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhZXJybnV6ZGRmeGZ0aGxsdnByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MjM0OTIsImV4cCI6MjA3NzM5OTQ5Mn0.u7f365U3CFFq_BF2NSnT9WhDGw0bZ8PjnmzphCwYPMM';
  
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Current admin user
  let currentAdmin = null;
  let currentWithdrawalFilter = 'all';
  let userToDelete = null;
  let allUsers = [];

  // Notification System
  function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type} show`;
    
    setTimeout(() => {
      notification.classList.remove('show');
    }, 5000);
  }

  // Show withdrawal alert
  function showWithdrawalAlert(userName, amount) {
    const alert = document.getElementById('withdrawalAlert');
    const message = document.getElementById('alertMessage');
    
    message.textContent = `${userName} requested ‚Ç¨${amount}`;
    alert.classList.add('show');
    
    // Auto-hide after 10 seconds
    setTimeout(() => {
      alert.classList.remove('show');
    }, 10000);
  }

  // Mobile Menu Toggle
  function toggleMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('mobile-open');
  }

  // Go Home function
  function goHome() {
    window.location.href = 'index.html';
  }

  // Check Admin Authentication
  async function checkAdminAuth() {
    try {
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      
      if (sessionError) {
        console.error('Session error:', sessionError);
        showAccessDenied();
        return false;
      }
      
      if (!session) {
        showNotification('Please login to access admin portal', 'error');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);
        return false;
      }

      // For now, allow any authenticated user to access admin
      // In production, you should check for specific admin roles/emails
      currentAdmin = session.user;
      document.getElementById('adminEmail').textContent = currentAdmin.email;
      document.getElementById('adminContent').style.display = 'block';
      document.getElementById('accessDenied').style.display = 'none';
      
      showNotification('Admin access granted. Welcome!', 'success');
      return true;

    } catch (error) {
      console.error('Auth check error:', error);
      showAccessDenied();
      return false;
    }
  }

  // Show access denied screen
  function showAccessDenied() {
    document.getElementById('adminContent').style.display = 'none';
    document.getElementById('accessDenied').style.display = 'block';
  }

  // Get status CSS class
  function getStatusClass(status) {
    switch(status?.toLowerCase()) {
      case 'active':
      case 'paid':
        return 'status-active';
      case 'pending':
        return 'status-pending';
      case 'processing':
        return 'status-processing';
      case 'rejected':
        return 'status-rejected';
      default:
        return 'status-pending';
    }
  }

  // Tab Management
  function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`${tabName}-tab`).classList.add('active');
    
    // Update sidebar active state
    document.querySelectorAll('.sidebar-menu a').forEach(link => {
      link.classList.remove('active');
    });
    event.target.classList.add('active');

    // Close mobile menu on tab change
    if (window.innerWidth <= 768) {
      toggleMobileMenu();
    }

    // Load tab data
    if (tabName === 'dashboard') {
      loadDashboard();
    } else if (tabName === 'users') {
      loadUsers();
    } else if (tabName === 'withdrawals') {
      loadWithdrawals();
    } else if (tabName === 'payments') {
      loadPaymentMethods();
    }
  }

  // Load Dashboard Data
  async function loadDashboard() {
    try {
      // Load total users
      const { data: users, error: usersError } = await supabase
        .from('profiles')
        .select('*');

      if (usersError) throw usersError;

      const totalUsers = users?.length || 0;
      const paypalUsers = users?.filter(user => user.paypal_email).length || 0;

      document.getElementById('totalUsers').textContent = totalUsers;
      document.getElementById('totalUsersQuick').textContent = totalUsers;
      document.getElementById('paypalUsers').textContent = paypalUsers;

      // Load withdrawal counts by status
      const { data: withdrawals, error: withdrawalsError } = await supabase
        .from('withdrawal_requests')
        .select('status, requested_at');

      if (withdrawalsError) throw withdrawalsError;

      const pendingWithdrawals = withdrawals?.filter(w => w.status === 'pending').length || 0;
      const processingWithdrawals = withdrawals?.filter(w => w.status === 'processing').length || 0;
      
      // Count new requests (last 24 hours)
      const newRequests = withdrawals?.filter(w => 
        w.status === 'pending' && 
        new Date(w.requested_at) > new Date(Date.now() - 24 * 60 * 60 * 1000)
      ).length || 0;

      document.getElementById('pendingWithdrawals').textContent = pendingWithdrawals;
      document.getElementById('pendingWithdrawalsQuick').textContent = pendingWithdrawals;
      document.getElementById('processingWithdrawals').textContent = processingWithdrawals;

      // Add new requests badge if any
      const pendingElement = document.getElementById('pendingWithdrawals');
      if (newRequests > 0) {
        pendingElement.innerHTML = `${pendingWithdrawals} <span class="new-request-badge">+${newRequests} new</span>`;
      }

      // Load total revenue and active contracts
      const { data: stats, error: statsError } = await supabase
        .from('creator_stats')
        .select('revenue, contract_status');

      if (statsError) throw statsError;

      const totalRevenue = stats?.reduce((sum, stat) => sum + (parseFloat(stat.revenue) || 0), 0) || 0;
      const activeContracts = stats?.filter(stat => stat.contract_status === 'Active').length || 0;

      document.getElementById('totalRevenue').textContent = `‚Ç¨${totalRevenue.toLocaleString()}`;
      document.getElementById('totalRevenueQuick').textContent = `‚Ç¨${totalRevenue.toLocaleString()}`;
      document.getElementById('activeContracts').textContent = activeContracts;
      document.getElementById('activeContractsQuick').textContent = activeContracts;

      // Load recent withdrawals
      loadRecentWithdrawals();

    } catch (error) {
      console.error('Error loading dashboard:', error);
      showNotification('Error loading dashboard data', 'error');
    }
  }

  // Load Recent Withdrawals for Dashboard
  async function loadRecentWithdrawals() {
    try {
      const { data: withdrawals, error } = await supabase
        .from('withdrawal_requests')
        .select(`
          *,
          profiles (full_name, email, paypal_email)
        `)
        .order('requested_at', { ascending: false })
        .limit(10);

      if (error) throw error;

      const tbody = document.getElementById('recentWithdrawalsBody');
      tbody.innerHTML = '';

      if (withdrawals.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">
              <div>üí∞</div>
              <div>No withdrawal requests found</div>
            </td>
          </tr>
        `;
        return;
      }

      withdrawals.forEach(withdrawal => {
        const profile = withdrawal.profiles;
        const isNewRequest = withdrawal.status === 'pending' && 
                            new Date(withdrawal.requested_at) > new Date(Date.now() - 5 * 60 * 1000);
        
        const row = document.createElement('tr');
        if (isNewRequest) {
          row.classList.add('urgent-withdrawal');
        }
        
        row.innerHTML = `
          <td>
            <strong>${profile?.full_name || 'N/A'}</strong>
            ${isNewRequest ? '<span class="new-request-badge">NEW</span>' : ''}
            <br>
            <small>${profile?.email || 'N/A'}</small>
          </td>
          <td><strong>‚Ç¨${withdrawal.amount.toLocaleString()}</strong></td>
          <td>${withdrawal.paypal_email || '<span class="no-paypal">No PayPal</span>'}</td>
          <td>
            ${new Date(withdrawal.requested_at).toLocaleDateString()}
            <br>
            <small>${new Date(withdrawal.requested_at).toLocaleTimeString()}</small>
          </td>
          <td>
            <span class="status-badge ${getStatusClass(withdrawal.status)}">
              ${withdrawal.status}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-primary btn-sm" onclick="openProcessModal('${withdrawal.id}')">
                ${isNewRequest ? 'üîÑ Process' : 'Manage'}
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });

    } catch (error) {
      console.error('Error loading recent withdrawals:', error);
    }
  }

  // Load All Users with Stats
  async function loadUsers() {
    try {
      const { data: users, error } = await supabase
        .from('profiles')
        .select(`
          *,
          creator_stats (*)
        `)
        .order('created_at', { ascending: false });

      if (error) throw error;

      allUsers = users || [];
      renderUsersTable(allUsers);

    } catch (error) {
      console.error('Error loading users:', error);
      showNotification('Error loading users', 'error');
    }
  }

  // Render users table with data
  function renderUsersTable(users) {
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';

    if (users.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="10" class="empty-state">
            <div>üë•</div>
            <div>No users found</div>
          </td>
        </tr>
      `;
      return;
    }

    users.forEach(user => {
      const stats = user.creator_stats?.[0];
      const hasPayPal = user.paypal_email && user.paypal_email.trim() !== '';
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${user.full_name || 'N/A'}</td>
        <td>${user.email}</td>
        <td>
          ${hasPayPal ? 
            `<span class="paypal-email">${user.paypal_email}</span>` : 
            '<span class="no-paypal">Not set</span>'
          }
        </td>
        <td>${user.youtube_channel ? `<a href="${user.youtube_channel}" target="_blank">View</a>` : 'N/A'}</td>
        <td>${stats?.total_views?.toLocaleString() || '0'}</td>
        <td>‚Ç¨${(stats?.available_balance || 0).toLocaleString()}</td>
        <td>‚Ç¨${stats?.revenue?.toLocaleString() || '0.00'}</td>
        <td><span class="status-badge ${getStatusClass(stats?.contract_status)}">${stats?.contract_status || 'No Data'}</span></td>
        <td>${stats?.last_updated ? new Date(stats.last_updated).toLocaleDateString() : 'Never'}</td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-primary btn-sm" onclick="editUser('${user.id}')">Edit Stats</button>
            <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}', '${user.full_name || user.email}')">Delete</button>
            ${hasPayPal ? '<span class="payment-badge">PayPal</span>' : ''}
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  // Filter users by search
  function filterUsers() {
    const searchTerm = document.getElementById('userSearch').value.toLowerCase();
    const filteredUsers = allUsers.filter(user => 
      (user.full_name && user.full_name.toLowerCase().includes(searchTerm)) ||
      user.email.toLowerCase().includes(searchTerm) ||
      (user.youtube_channel && user.youtube_channel.toLowerCase().includes(searchTerm))
    );
    renderUsersTable(filteredUsers);
  }

  // Load Withdrawal Requests
  async function loadWithdrawals() {
    try {
      const { data: withdrawals, error } = await supabase
        .from('withdrawal_requests')
        .select(`
          *,
          profiles (full_name, email, paypal_email)
        `)
        .order('requested_at', { ascending: false });

      if (error) throw error;

      // Update quick stats
      const totalWithdrawals = withdrawals?.length || 0;
      const pendingCount = withdrawals?.filter(w => w.status === 'pending').length || 0;
      const processingCount = withdrawals?.filter(w => w.status === 'processing').length || 0;
      const paidCount = withdrawals?.filter(w => w.status === 'paid').length || 0;
      
      document.getElementById('totalWithdrawals').textContent = totalWithdrawals;
      document.getElementById('pendingCount').textContent = pendingCount;
      document.getElementById('processingCount').textContent = processingCount;
      document.getElementById('paidCount').textContent = paidCount;

      const tbody = document.getElementById('withdrawalsTableBody');
      tbody.innerHTML = '';

      if (withdrawals.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <div>üí∞</div>
              <div>No withdrawal requests found</div>
            </td>
          </tr>
        `;
        return;
      }

      // Filter withdrawals based on current filter
      const filteredWithdrawals = currentWithdrawalFilter === 'all' 
        ? withdrawals 
        : withdrawals.filter(w => w.status === currentWithdrawalFilter);

      if (filteredWithdrawals.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
              No ${currentWithdrawalFilter} withdrawal requests found
            </td>
          </tr>
        `;
        return;
      }

      for (const withdrawal of filteredWithdrawals) {
        // Get creator stats separately for each withdrawal
        const { data: stats, error: statsError } = await supabase
          .from('creator_stats')
          .select('available_balance, revenue')
          .eq('creator_id', withdrawal.creator_id)
          .single();

        const profile = withdrawal.profiles;
        const availableBalance = stats?.available_balance || 0;
        const totalRevenue = stats?.revenue || 0;
        const isNewRequest = withdrawal.status === 'pending' && 
                            new Date(withdrawal.requested_at) > new Date(Date.now() - 5 * 60 * 1000);
        
        // Balance check
        const hasSufficientBalance = availableBalance >= withdrawal.amount;
        const balanceStatus = hasSufficientBalance ? 
          '<div class="balance-ok">‚úì Sufficient Balance</div>' : 
          '<div class="balance-warning">‚ö†Ô∏è Insufficient Balance</div>';
        
        const row = document.createElement('tr');
        if (isNewRequest) {
          row.classList.add('urgent-withdrawal');
        }
        
        row.innerHTML = `
          <td>
            <strong>${profile?.full_name || 'N/A'}</strong>
            ${isNewRequest ? '<span class="new-request-badge">NEW</span>' : ''}
            <br>
            <small>${profile?.email || 'N/A'}</small>
          </td>
          <td>
            ${withdrawal.paypal_email ? 
              `<span class="paypal-email">${withdrawal.paypal_email}</span>` : 
              '<span class="no-paypal">No PayPal</span>'
            }
          </td>
          <td><strong>‚Ç¨${withdrawal.amount.toLocaleString()}</strong></td>
          <td>
            ${new Date(withdrawal.requested_at).toLocaleDateString()}
            <br>
            <small>${new Date(withdrawal.requested_at).toLocaleTimeString()}</small>
          </td>
          <td>
            <span class="status-badge ${getStatusClass(withdrawal.status)}">
              ${withdrawal.status.toUpperCase()}
            </span>
          </td>
          <td>
            <strong>Available:</strong> ‚Ç¨${availableBalance.toLocaleString()}<br>
            <strong>Total Revenue:</strong> ‚Ç¨${totalRevenue.toLocaleString()}
            ${balanceStatus}
            ${withdrawal.admin_notes ? `<br><small><strong>Notes:</strong> ${withdrawal.admin_notes}</small>` : ''}
          </td>
          <td>
            <div class="action-buttons">
              ${withdrawal.status === 'pending' || withdrawal.status === 'processing' ? `
                <button class="btn btn-primary btn-sm" onclick="openProcessModal('${withdrawal.id}')">
                  ${isNewRequest ? 'üîÑ Process' : 'Manage'}
                </button>
              ` : `
                <button class="btn btn-info btn-sm" onclick="openProcessModal('${withdrawal.id}')">
                  View Details
                </button>
              `}
              ${withdrawal.processed_at ? `
                <br><small>Processed: ${new Date(withdrawal.processed_at).toLocaleDateString()}</small>
              ` : ''}
            </div>
          </td>
        `;
        tbody.appendChild(row);
      }

    } catch (error) {
      console.error('Error loading withdrawals:', error);
      showNotification('Error loading withdrawal requests', 'error');
    }
  }

  // Filter withdrawals by status
  function filterWithdrawals(status) {
    currentWithdrawalFilter = status;
    
    // Update tab active states
    document.querySelectorAll('.tabs .tab').forEach(tab => {
      tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    loadWithdrawals();
  }

  // Load Payment Methods
  async function loadPaymentMethods() {
    try {
      const { data: users, error } = await supabase
        .from('profiles')
        .select(`
          *,
          creator_stats (available_balance, last_updated)
        `)
        .order('created_at', { ascending: false });

      if (error) throw error;

      const tbody = document.getElementById('paymentsTableBody');
      tbody.innerHTML = '';

      if (users.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <div>üí≥</div>
              <div>No users found</div>
            </td>
          </tr>
        `;
        return;
      }

      for (const user of users) {
        const stats = user.creator_stats?.[0];
        const hasPayPal = user.paypal_email && user.paypal_email.trim() !== '';
        
        // Get last withdrawal separately
        const { data: lastWithdrawal, error: withdrawalError } = await supabase
          .from('withdrawal_requests')
          .select('amount, requested_at')
          .eq('creator_id', user.id)
          .order('requested_at', { ascending: false })
          .limit(1)
          .single();

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${user.full_name || 'N/A'}</td>
          <td>${user.email}</td>
          <td>
            ${hasPayPal ? 
              `<span class="paypal-email">${user.paypal_email}</span>` : 
              '<span class="no-paypal">Not configured</span>'
            }
          </td>
          <td>
            <span class="status-badge ${hasPayPal ? 'status-active' : 'status-pending'}">
              ${hasPayPal ? 'Configured' : 'Pending'}
            </span>
          </td>
          <td>‚Ç¨${(stats?.available_balance || 0).toLocaleString()}</td>
          <td>
            ${lastWithdrawal ? 
              `${new Date(lastWithdrawal.requested_at).toLocaleDateString()} (‚Ç¨${lastWithdrawal.amount})` : 
              'Never'
            }
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-primary btn-sm" onclick="editUser('${user.id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}', '${user.full_name || user.email}')">Delete</button>
              ${!hasPayPal && 
                `<button class="btn btn-warning btn-sm" onclick="remindPaypalSetup('${user.id}', '${user.email}')">
                  Remind
                </button>`
              }
            </div>
          </td>
        `;
        tbody.appendChild(row);
      }

    } catch (error) {
      console.error('Error loading payment methods:', error);
      showNotification('Error loading payment methods', 'error');
    }
  }

  // Remind user to setup PayPal
  function remindPaypalSetup(userId, userEmail) {
    if (confirm(`Send PayPal setup reminder to ${userEmail}?`)) {
      showNotification(`Reminder sent to ${userEmail}`, 'info');
    }
  }

  // Delete User Function
  function deleteUser(userId, userName) {
    userToDelete = { id: userId, name: userName };
    
    // Get user email for display
    const userRow = document.querySelector(`tr:has(button[onclick="deleteUser('${userId}'"])`);
    const userEmail = userRow ? userRow.cells[1].textContent : 'N/A';
    
    document.getElementById('deleteUserName').textContent = userName;
    document.getElementById('deleteUserEmail').textContent = userEmail;
    document.getElementById('confirmDelete').value = '';
    document.getElementById('confirmDeleteBtn').disabled = true;
    
    document.getElementById('deleteUserModal').style.display = 'flex';
  }

  // Close Delete Modal
  function closeDeleteModal() {
    document.getElementById('deleteUserModal').style.display = 'none';
    userToDelete = null;
  }

  // Confirm Delete User
  async function confirmDeleteUser() {
    if (!userToDelete) return;
    
    try {
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      confirmBtn.innerHTML = '<span class="loading"></span>Deleting...';
      confirmBtn.disabled = true;

      // Delete user data in sequence
      // 1. First delete withdrawal requests
      const { error: withdrawalError } = await supabase
        .from('withdrawal_requests')
        .delete()
        .eq('creator_id', userToDelete.id);

      if (withdrawalError) throw withdrawalError;

      // 2. Delete creator stats
      const { error: statsError } = await supabase
        .from('creator_stats')
        .delete()
        .eq('creator_id', userToDelete.id);

      if (statsError) throw statsError;

      // 3. Delete user profile
      const { error: profileError } = await supabase
        .from('profiles')
        .delete()
        .eq('id', userToDelete.id);

      if (profileError) throw profileError;

      showNotification(`User ${userToDelete.name} deleted successfully!`, 'success');
      closeDeleteModal();
      
      // Refresh all tabs
      setTimeout(() => {
        loadDashboard();
        loadUsers();
        loadWithdrawals();
        loadPaymentMethods();
      }, 1000);

    } catch (error) {
      console.error('Error deleting user:', error);
      showNotification('Error deleting user: ' + error.message, 'error');
    } finally {
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      confirmBtn.innerHTML = 'Delete User Permanently';
      confirmBtn.disabled = false;
    }
  }

  // Enable delete button when user types "DELETE"
  document.getElementById('confirmDelete').addEventListener('input', function(e) {
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    confirmBtn.disabled = e.target.value.toUpperCase() !== 'DELETE';
  });

  // Open Process Withdrawal Modal
  async function openProcessModal(withdrawalId) {
    try {
      console.log('Loading withdrawal details for ID:', withdrawalId);
      
      // Get withdrawal with user profile
      const { data: withdrawal, error: withdrawalError } = await supabase
        .from('withdrawal_requests')
        .select(`
          *,
          profiles (full_name, email, paypal_email)
        `)
        .eq('id', withdrawalId)
        .single();

      if (withdrawalError) {
        console.error('Error loading withdrawal:', withdrawalError);
        throw withdrawalError;
      }

      if (!withdrawal) {
        throw new Error('Withdrawal request not found');
      }

      // Get creator stats separately
      const { data: stats, error: statsError } = await supabase
        .from('creator_stats')
        .select('available_balance, revenue')
        .eq('creator_id', withdrawal.creator_id)
        .single();

      const profile = withdrawal.profiles;
      const availableBalance = stats?.available_balance || 0;

      document.getElementById('processWithdrawalId').value = withdrawalId;
      document.getElementById('deductionAmount').textContent = withdrawal.amount.toLocaleString();
      
      // Populate withdrawal details
      document.getElementById('withdrawalDetailsContent').innerHTML = `
        <div class="detail-row">
          <span class="detail-label">User:</span>
          <span class="detail-value">${profile?.full_name || 'N/A'} (${profile?.email})</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">PayPal Email:</span>
          <span class="detail-value">${withdrawal.paypal_email || 'Not provided'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Amount:</span>
          <span class="detail-value"><strong>‚Ç¨${withdrawal.amount.toLocaleString()}</strong></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Available Balance:</span>
          <span class="detail-value">‚Ç¨${availableBalance.toLocaleString()}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Balance After:</span>
          <span class="detail-value">‚Ç¨${(availableBalance - withdrawal.amount).toLocaleString()}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Current Status:</span>
          <span class="detail-value"><span class="status-badge ${getStatusClass(withdrawal.status)}">${withdrawal.status}</span></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Requested:</span>
          <span class="detail-value">${new Date(withdrawal.requested_at).toLocaleString()}</span>
        </div>
        ${withdrawal.admin_notes ? `
        <div class="detail-row">
          <span class="detail-label">Admin Notes:</span>
          <span class="detail-value">${withdrawal.admin_notes}</span>
        </div>
        ` : ''}
      `;

      // Set current status in dropdown
      document.getElementById('withdrawalAction').value = withdrawal.status;
      toggleNotesField();

      // Show modal
      document.getElementById('processWithdrawalModal').style.display = 'flex';

    } catch (error) {
      console.error('Error loading withdrawal details:', error);
      showNotification('Error loading withdrawal details: ' + error.message, 'error');
    }
  }

  // Toggle notes field based on selected action
  function toggleNotesField() {
    const action = document.getElementById('withdrawalAction').value;
    const notesField = document.getElementById('notesField');
    const balanceWarning = document.getElementById('balanceWarning');
    
    // Show notes for rejected status, hide for others
    if (action === 'rejected') {
      notesField.style.display = 'block';
      balanceWarning.style.display = 'none';
    } else if (action === 'paid') {
      notesField.style.display = 'block';
      balanceWarning.style.display = 'block';
    } else {
      notesField.style.display = 'block';
      balanceWarning.style.display = 'none';
    }
  }

  // Close Process Modal
  function closeProcessModal() {
    document.getElementById('processWithdrawalModal').style.display = 'none';
  }

  // Process Withdrawal
  document.getElementById('processWithdrawalForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const withdrawalId = document.getElementById('processWithdrawalId').value;
    const action = document.getElementById('withdrawalAction').value;
    const adminNotes = document.getElementById('adminNotes').value;

    // Validate notes for rejected withdrawals
    if (action === 'rejected' && !adminNotes.trim()) {
      showNotification('Please provide notes explaining why the withdrawal was rejected.', 'error');
      return;
    }

    try {
      const processBtn = document.getElementById('processWithdrawalBtn');
      processBtn.innerHTML = '<span class="loading"></span>Processing...';
      processBtn.disabled = true;

      // Use the process_withdrawal function
      const { data, error } = await supabase.rpc('process_withdrawal', {
        p_withdrawal_id: withdrawalId,
        p_new_status: action,
        p_admin_notes: adminNotes
      });

      if (error) {
        console.error('RPC Error:', error);
        throw error;
      }

      if (data) {
        showNotification(`Withdrawal ${getActionDescription(action)} successfully!`, 'success');
        
        closeProcessModal();
        
        // Refresh the withdrawals table and dashboard
        setTimeout(() => {
          loadWithdrawals();
          loadDashboard();
        }, 1000);
      } else {
        throw new Error('Failed to process withdrawal - no data returned');
      }

    } catch (error) {
      console.error('Error processing withdrawal:', error);
      showNotification('Error processing withdrawal: ' + error.message, 'error');
    } finally {
      const processBtn = document.getElementById('processWithdrawalBtn');
      processBtn.innerHTML = 'Update Status';
      processBtn.disabled = false;
    }
  });

  // Helper function to get action description
  function getActionDescription(action) {
    switch(action) {
      case 'paid': return 'marked as PAID';
      case 'processing': return 'marked as PROCESSING';
      case 'rejected': return 'REJECTED';
      case 'pending': return 'left as PENDING';
      default: return 'updated';
    }
  }

  // Edit User Modal
  async function editUser(userId) {
    try {
      // Load user data
      const { data: user, error: userError } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', userId)
        .single();

      if (userError) throw userError;

      // Load user stats
      const { data: stats, error: statsError } = await supabase
        .from('creator_stats')
        .select('*')
        .eq('creator_id', userId)
        .single();

      if (statsError && statsError.code !== 'PGRST116') throw statsError;

      // Populate modal
      document.getElementById('editUserId').value = userId;
      document.getElementById('editTotalViews').value = stats?.total_views || 0;
      document.getElementById('editMonetizedViews').value = stats?.monetized_views || 0;
      document.getElementById('editRevenue').value = stats?.revenue || 0;
      document.getElementById('editAvailableBalance').value = stats?.available_balance || 0;
      document.getElementById('editContractStatus').value = stats?.contract_status || 'Pending';

      // Show modal
      document.getElementById('editUserModal').style.display = 'flex';

    } catch (error) {
      console.error('Error loading user data:', error);
      showNotification('Error loading user data', 'error');
    }
  }

  // Close Edit Modal
  function closeEditModal() {
    document.getElementById('editUserModal').style.display = 'none';
  }

  // Save User Stats
  document.getElementById('editUserForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const userId = document.getElementById('editUserId').value;
    const totalViews = parseInt(document.getElementById('editTotalViews').value);
    const monetizedViews = parseInt(document.getElementById('editMonetizedViews').value);
    const revenue = parseFloat(document.getElementById('editRevenue').value);
    const availableBalance = parseFloat(document.getElementById('editAvailableBalance').value);
    const contractStatus = document.getElementById('editContractStatus').value;

    try {
      // Check if stats already exist
      const { data: existingStats, error: checkError } = await supabase
        .from('creator_stats')
        .select('id')
        .eq('creator_id', userId)
        .single();

      let result;
      if (existingStats) {
        // Update existing stats
        result = await supabase
          .from('creator_stats')
          .update({
            total_views: totalViews,
            monetized_views: monetizedViews,
            revenue: revenue,
            available_balance: availableBalance,
            contract_status: contractStatus,
            last_updated: new Date().toISOString()
          })
          .eq('creator_id', userId);
      } else {
        // Insert new stats
        result = await supabase
          .from('creator_stats')
          .insert([
            {
              creator_id: userId,
              total_views: totalViews,
              monetized_views: monetizedViews,
              revenue: revenue,
              available_balance: availableBalance,
              contract_status: contractStatus,
              last_updated: new Date().toISOString()
            }
          ]);
      }

      if (result.error) throw result.error;

      showNotification('User stats updated successfully!', 'success');
      closeEditModal();
      
      // Refresh current tab
      const activeTab = document.querySelector('.tab-content.active').id;
      if (activeTab === 'dashboard-tab') {
        loadDashboard();
      } else if (activeTab === 'users-tab') {
        loadUsers();
      }

    } catch (error) {
      console.error('Error updating user stats:', error);
      showNotification('Error updating user stats', 'error');
    }
  });

  // Logout
  async function logout() {
    try {
      const { error } = await supabase.auth.signOut();
      if (error) throw error;
      
      showNotification('Logged out successfully', 'success');
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 1500);
    } catch (error) {
      showNotification('Error logging out', 'error');
    }
  }

  // Real-time Subscriptions
  function setupRealtimeSubscriptions() {
    // Subscribe to new withdrawal requests with better handling
    supabase
      .channel('new_withdrawal_requests')
      .on('postgres_changes', 
        { event: 'INSERT', schema: 'public', table: 'withdrawal_requests' },
        async (payload) => {
          console.log('New withdrawal request:', payload);
          
          // Get user details for the notification
          const { data: user, error } = await supabase
            .from('profiles')
            .select('full_name, email')
            .eq('id', payload.new.creator_id)
            .single();

          if (user) {
            showWithdrawalAlert(user.full_name || user.email, payload.new.amount);
          }
          
          // Update dashboard counts
          loadDashboard();
          loadWithdrawals();
        }
      )
      .subscribe();

    // Subscribe to withdrawal updates
    supabase
      .channel('withdrawal_updates')
      .on('postgres_changes', 
        { event: 'UPDATE', schema: 'public', table: 'withdrawal_requests' },
        (payload) => {
          console.log('Withdrawal updated:', payload);
          loadDashboard();
          loadWithdrawals();
        }
      )
      .subscribe();

    // Subscribe to profile updates (PayPal email changes)
    supabase
      .channel('profile_updates')
      .on('postgres_changes', 
        { event: 'UPDATE', schema: 'public', table: 'profiles' },
        (payload) => {
          if (payload.new.paypal_email !== payload.old.paypal_email) {
            showNotification(`User updated PayPal email`, 'info');
            loadDashboard();
            loadPaymentMethods();
          }
        }
      )
      .subscribe();

    // Subscribe to user deletions
    supabase
      .channel('user_deletions')
      .on('postgres_changes', 
        { event: 'DELETE', schema: 'public', table: 'profiles' },
        (payload) => {
          console.log('User deleted:', payload);
          showNotification('User account was deleted', 'info');
          loadDashboard();
          loadUsers();
          loadPaymentMethods();
        }
      )
      .subscribe();
  }

  // Initialize Admin Portal
  document.addEventListener('DOMContentLoaded', async function() {
    const isAdmin = await checkAdminAuth();
    
    if (isAdmin) {
      loadDashboard();
      setupRealtimeSubscriptions();
    }
  });

  // Close modals when clicking outside
  window.addEventListener('click', function(event) {
    const editModal = document.getElementById('editUserModal');
    const deleteModal = document.getElementById('deleteUserModal');
    const processModal = document.getElementById('processWithdrawalModal');
    
    if (event.target === editModal) {
      closeEditModal();
    }
    if (event.target === deleteModal) {
      closeDeleteModal();
    }
    if (event.target === processModal) {
      closeProcessModal();
    }
  });
</script>
</body>
</html>